# -*- coding: utf-8 -*-
"""acdt_g31

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1F5fm0D95_3CLMpKv3LVVCJCWz4Vwmcv_
"""

# ================================
# GERD â†” GDP Full Dashboard (final)
# ================================
import streamlit as st
import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt
import statsmodels.formula.api as smf

st.set_page_config(page_title="GERD & GDP â€“ ACDT Group 31", layout="wide")

DATA_FILE = "ACDT_final_dataset.csv"   # <= ë ˆí¬ì— ì˜¬ë¦° íŒŒì¼ëª… ê·¸ëŒ€ë¡œ

# ---------- 1) ë¡œë”© + ì „ì²˜ë¦¬ ----------
@st.cache_data
def load_data(path: str) -> pd.DataFrame:
    # 1) ì¸ì½”ë”©/êµ¬ë¶„ì ìœ ì—° ë¡œë”©
    df_raw = None
    last_err = None
    for enc in ("utf-8-sig", "cp949"):
        try:
            # header=None: 0í–‰=ì—°ë„, 1í–‰=ì§€í‘œëª…
            df_raw = pd.read_csv(path, header=None, encoding=enc, engine="python")
            break
        except Exception as e:
            last_err = e
            continue
    if df_raw is None:
        raise RuntimeError(f"CSV read failed: {last_err}")

    # 2) í˜¹ì‹œ ì—´ì´ 1ê°œë¡œ ë¶™ì–´ìˆìœ¼ë©´(â€˜í•œ ì…€ CSVâ€™) êµ¬ë¶„ì ì¶”ì •
    if df_raw.shape[1] == 1:
        cell = df_raw.iloc[0, 0]
        if isinstance(cell, str):
            for sep in (",", "\t", ";"):
                if sep in cell:
                    df_raw = df_raw[0].str.split(sep, expand=True)
                    break

    # 3) 1í–‰(ë‘ ë²ˆì§¸ ì¤„)ì„ â€˜ë¬´ì¡°ê±´â€™ Seriesë¡œ ë§Œë“¤ì–´ ì»¬ëŸ¼ëª…ìœ¼ë¡œ ì‚¬ìš©
    header_candidate = df_raw.iloc[1]
    if not isinstance(header_candidate, pd.Series):
        header_candidate = pd.Series(list(header_candidate))

    header = header_candidate.astype(str).values
    df = df_raw.iloc[2:].copy()
    df.columns = header

    # 4) ìˆ«ìí™”: ê° "ì—´(Series)"ì—ë§Œ .str ì ìš© (DataFrame ì „ì²´ì— .str ê¸ˆì§€!)
    def to_numeric_series(s: pd.Series) -> pd.Series:
        s = s.astype(str)
        # ì‰¼í‘œ ì œê±° -> ìˆ«ì/ì§€ìˆ˜ê¸°í˜¸/ë¶€í˜¸/ì ë§Œ ìœ ì§€
        s = s.str.replace(",", "", regex=False)
        s = s.str.replace(r"[^0-9eE+\-\.]", "", regex=True)
        return pd.to_numeric(s, errors="coerce")

    for c in df.columns:
        df[c] = to_numeric_series(df[c])

    # 5) í•µì‹¬ ë³€ìˆ˜ ë¦¬ë„¤ì„ (íŒŒì¼ì˜ ì›ë˜ ì§€í‘œëª… â†’ ë¶„ì„ìš© í‘œì¤€ëª…)
    rename_map = {
        "Real GDP (billion USD, PPP-based, Chain-weighted, 2020 base year)": "Real_GDP",
        "Gross Domestic Expenditure on R&D (GERD) (current PPP USD)": "GERD",
        # (í•„ìš”ì‹œ ì—¬ê¸°ì— ë‹¤ë¥¸ ì§€í‘œëª…ë„ ì¶”ê°€)
    }
    df.rename(columns=rename_map, inplace=True)

    # 6) í•„ìˆ˜ ì»¬ëŸ¼ ì²´í¬
    if "Real_GDP" not in df.columns or "GERD" not in df.columns:
        # ë””ë²„ê¹…ì„ ìœ„í•´ ì–´ë–¤ ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ ë³´ì—¬ì¤Œ
        raise KeyError(
            "Missing 'Real_GDP' or 'GERD' columns after cleaning. "
            f"Current columns: {list(df.columns)[:15]} ..."
        )

    # 7) ë¡œê·¸ë³€í™˜ (0/ìŒìˆ˜ ë³´í˜¸)
    df["ln_GDP"] = np.log(df["Real_GDP"].replace({0: np.nan}))
    df["ln_GERD"] = np.log(df["GERD"].replace({0: np.nan}))

    return df.dropna(subset=["ln_GDP", "ln_GERD"])

# ---------- UI ----------
st.title("ğŸ“ˆ GERD and GDP Full Regression Dashboard â€“ ACDT Group 31")

try:
    df = load_data(DATA_FILE)
except Exception as e:
    st.error(f"Error loading data: {e}")
    st.stop()

st.success("âœ… Data successfully loaded and cleaned.")
st.dataframe(df.head())

# ---------- ë³€ìˆ˜ ë¶„í¬ ----------
st.header("ğŸ“Š Variable Distribution")
num_cols = df.select_dtypes(include=np.number).columns.tolist()
if num_cols:
    var = st.selectbox("Select a variable", num_cols, index=num_cols.index("ln_GERD") if "ln_GERD" in num_cols else 0)
    fig, ax = plt.subplots(1, 2, figsize=(12, 4))
    sns.histplot(df[var], kde=True, ax=ax[0])
    ax[0].set_title(f"Histogram: {var}")
    sns.boxplot(x=df[var], ax=ax[1])
    ax[1].set_title(f"Boxplot: {var}")
    st.pyplot(fig)

# ---------- ìƒê´€í–‰ë ¬ ----------
st.header("ğŸ“ˆ Correlation Matrix")
corr = df.select_dtypes(include=np.number).corr()
fig_corr, ax_corr = plt.subplots(figsize=(10, 7))
sns.heatmap(corr, annot=True, fmt=".2f", cmap="coolwarm", ax=ax_corr)
st.pyplot(fig_corr)

# ---------- íšŒê·€ (Model 1â€“4) ----------
st.header("ğŸ§® Regression Models (Model 1â€“4)")

# ë°ì´í„°ì…‹ ì»¬ëŸ¼ëª…(ì¤‘ì¬Â·ë§¤ê°œÂ·êµë€)ì€ ë„ˆí¬ê°€ ì“°ë˜ ì´ë¦„ ê·¸ëŒ€ë¡œ ìœ ì§€
confounders = ["GDP per Capita", "Labor Force Size"]
mediators = [
    "Resident Patent Applications",
    "Non-Resident Patent Applications",
    "R&D Researchers per Million People",
    "High-tech Export Share (% of Manufactured Exports)",
    "Business R&D Personnel (FTE)",
]
moderators = ["Government-financed BERD (%)", "Business-financed BERD (%)"]

models = {}

try:
    # Model 1: ë‹¨ìˆœ (íƒ„ë ¥ì„±)
    models["Model 1"] = smf.ols("ln_GDP ~ ln_GERD", data=df).fit()

    # Model 2: êµë€ í†µì œ
    valid_conf = [c for c in confounders if c in df.columns]
    if valid_conf:
        models["Model 2"] = smf.ols(
            f"ln_GDP ~ ln_GERD + {' + '.join([f'Q(\"{c}\")' for c in valid_conf])}", data=df
        ).fit()
    else:
        models["Model 2"] = models["Model 1"]

    # Model 3: ë§¤ê°œ ë³€ìˆ˜ í¬í•¨
    valid_med = [m for m in mediators if m in df.columns]
    if valid_med:
        models["Model 3"] = smf.ols(
            f"ln_GDP ~ ln_GERD + {' + '.join([f'Q(\"{m}\")' for m in valid_med])}", data=df
        ).fit()
    else:
        models["Model 3"] = models["Model 2"]

    # Model 4: ì¡°ì ˆ(ìƒí˜¸ì‘ìš©) + ë§¤ê°œ
    valid_mod = [mo for mo in moderators if mo in df.columns]
    if valid_mod:
        inter = " + ".join([f'ln_GERD * Q(\"{mo}\")' for mo in valid_mod])
        base = " + ".join([f'Q(\"{m}\")' for m in valid_med]) if valid_med else ""
        rhs = inter if not base else f"{inter} + {base}"
        models["Model 4"] = smf.ols(f"ln_GDP ~ {rhs}", data=df).fit()
    else:
        models["Model 4"] = models["Model 3"]

    # ìš”ì•½ í…Œì´ë¸”
    rows = []
    for name, m in models.items():
        rows.append(
            [name, m.params.get("ln_GERD", np.nan), m.pvalues.get("ln_GERD", np.nan), m.rsquared_adj]
        )
    sum_df = pd.DataFrame(rows, columns=["Model", "Î²(ln_GERD)", "p-value", "Adj. RÂ²"])
    st.subheader("ğŸ“˜ Model Comparison")
    st.dataframe(sum_df.round(4))

    # RÂ² ë§‰ëŒ€ê·¸ë˜í”„
    fig_r2, ax_r2 = plt.subplots(figsize=(7, 4))
    sns.barplot(x="Model", y="Adj. RÂ²", data=sum_df, ax=ax_r2)
    ax_r2.set_ylim(0, max(sum_df["Adj. RÂ²"]) * 1.1)
    st.pyplot(fig_r2)

    # ì‚°ì ë„ (ln_GERD vs ln_GDP)
    st.subheader("Scatter: ln(GERD) vs ln(GDP)")
    fig_sc, ax_sc = plt.subplots(figsize=(7, 5))
    sns.regplot(x="ln_GERD", y="ln_GDP", data=df, ax=ax_sc, scatter_kws={"alpha": 0.6})
    st.pyplot(fig_sc)

    # ìµœì¢… ëª¨ë¸ ì”ì°¨ íˆìŠ¤í† ê·¸ë¨
    st.subheader("Residuals (Final Model)")
    final = models.get("Model 4", list(models.values())[-1])
    fig_res, ax_res = plt.subplots(figsize=(7, 4))
    sns.histplot(final.resid, kde=True, ax=ax_res)
    st.pyplot(fig_res)

except Exception as e:
    st.error(f"Regression error: {e}")

# ---------- í•´ì„ ìš”ì•½ ----------
st.header("ğŸ§© Interpretation (quick)")
st.markdown("""
- **Model 1**: ln(GERD) â†— â†’ ln(GDP) â†— (íƒ„ë ¥ì„± ì¶”ì •).
- **Model 2**: êµë€(ì˜ˆ: 1ì¸ë‹¹ GDP, ë…¸ë™ê·œëª¨)ì„ í†µì œí•´ë„ ln(GERD) íš¨ê³¼ê°€ ìœ ì§€ë˜ëŠ”ì§€ í™•ì¸.
- **Model 3**: íŠ¹í—ˆÂ·ì—°êµ¬ì¸ë ¥Â·í•˜ì´í…Œí¬ ìˆ˜ì¶œÂ·ê¸°ì—… R&D ì¸ë ¥ ë“± **ë§¤ê°œ**ë¡œ ê²½ë¡œ ì¼ë¶€ ì„¤ëª…ë˜ëŠ”ì§€ í™•ì¸.
- **Model 4**: ì •ë¶€/ë¯¼ê°„ BERD ë¹„ì¤‘ì´ **ì¡°ì ˆ**(ìƒí˜¸ì‘ìš©)í•˜ë©° ln(GERD)â†’ln(GDP) íš¨ê³¼ í¬ê¸°ë¥¼ ë°”ê¾¸ëŠ”ì§€ í™•ì¸.
""")